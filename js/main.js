// Generated by CoffeeScript 2.3.0
var _createFieldControl, canSave, compile, components, container, delay, editor, engine, header, menu, moduleStackEditor, modulename, numSocket, openModule, saveModule;

delay = function(ms, func) {
  return setTimeout(func, ms);
};

_createFieldControl = function(type, value, key, placeholder = '') {
  return new D3NE.Control(`<input type=${type} value=${value} placeholder=${placeholder}>`, (el, c) => {
    var upd;
    upd = function() {
      if (type === 'number') {
        c.putData(key, parseFloat(el.value) || 0);
      } else {
        c.putData(key, el.value);
      }
      return editor.eventListener.trigger('change');
    };
    el.addEventListener('input', upd);
    el.addEventListener('mousedown', function(e) {
      return e.stopPropagation();
    });
    el.addEventListener('contextmenu', function(e) {
      return e.stopPropagation();
    });
    // prevent node movement when selecting text in the input field
    // prevent custom context menu
    return upd();
  });
};

numSocket = new D3NE.Socket('number', 'Number value', 'hint');

menu = new D3NE.ContextMenu({
  Nombre: componentNum,
  Fonctions: {
    Fonction: componentModule,
    Entrée: componentInput,
    Sortie: componentOutput,
    Identité: componentId,
    Carré: componentSquare,
    Racine: componentRac,
    Sinus: componentSin,
    Cosinus: componentCos
  },
  Opération: {
    Addition: componentAdd,
    Soustration: componentSous,
    Multiplication: componentMult,
    Division: componentDiv,
    Puissance: componentPow,
    Distance: componentDis
  },
  Comunication: {
    Message: componentMessage,
    'Message identique': componentMessageMatch,
    'Message envoyé': componentMessageSend
  },
  Évènement: {
    'Alerte': alertComp,
    'Entrée pressée': enterpressComp,
    'Touche enfoncée': keydownComp,
    'Évènement Message': componentMessageEvent
  },
  Action: function() {
    alert('ok');
  }
});

components = [componentNum, componentAdd, componentSous, componentMult, componentDiv, componentPow, componentSquare, componentSin, componentCos, componentRac, componentId, componentModule, componentInput, componentOutput, keydownComp, enterpressComp, alertComp, componentMessageEvent, componentMessageSend, componentMessageMatch, componentMessage];

container = document.querySelector('#d3ne');

editor = null;

header = document.querySelector('#moduleheader');

modulename = header.querySelector('input');

modulename.addEventListener('input', () => {
  return moduleStackEditor[moduleStackEditor.length - 1].module.name = modulename.value;
});

moduleStackEditor = [];

canSave = true;

saveModule = async function() {
  var data, module;
  ({module, data} = moduleStackEditor.pop());
  console.log("module", module, "data", data);
  module.data = editor.toJSON();
  await editor.fromJSON(data);
  editor.view.zoomAt(editor.nodes);
  if (moduleStackEditor.length === 0) {
    header.style.display = 'none';
  } else {
    modulename.value = moduleStackEditor[moduleStackEditor.length - 1].module.name;
  }
  editor.eventListener.trigger('change');
};

openModule = async function(m) {
  console.log(m);
  moduleStackEditor.push({
    data: editor.toJSON(),
    module: m
  });
  header.style.display = 'inline';
  modulename.value = m.name;
  await editor.fromJSON(m.data);
  editor.view.zoomAt(editor.nodes);
  return editor.eventListener.trigger('change');
};

editor = new D3NE.NodeEditor('demo@0.1.0', container, components, menu);

engine = new D3NE.Engine('demo@0.1.0', components);

moduleManager.setEngine(engine);

compile = async function() {
  var status;
  await engine.abort();
  status = (await engine.process(editor.toJSON()));
  return console.log(status);
};

$(function() {
  var load;
  load = function(file) {
    return $.getJSON(file, function(data) {
      console.log(data);
      return (async() => {
        await editor.fromJSON(data);
        editor.eventListener.on('change connectioncreate connectionremove nodecreate noderemove', (_, p) => {
          if (p) {
            return compile();
          }
        });
        editor.eventListener.on('error', (err) => {
          return alertify.error(err.message);
        });
        editor.view.zoomAt(editor.nodes);
        editor.view.resize();
        return editor.eventListener.trigger('change');
      })();
    });
  };
  $("#telegram").hide();
  load("dataOp.json");
  $("#Op").on("click", function() {
    load("dataOp.json");
    return $("#telegram").hide();
  });
  $("#Ev").on("click", function() {
    load("dataEv.json");
    return $("#telegram").hide();
  });
  return $("#Ai").on("click", function() {
    load("dataAi.json");
    return $("#telegram").show();
  });
});
